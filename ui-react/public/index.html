<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>시각적 탐사 데이터 분석 지원 도구</title>

    <!--region 부트스트랩-->
    <!--    <link href="../node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet">-->
    <!--    <script type="text/javascript" src="../node_modules/bootstrap/dist/js/bootstrap.js"></script>-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <link href="sidebars.css" rel="stylesheet">
    <script src="sidebars.js"></script>
    <!--endregion 부트스트랩-->
    <!--region 제이쿼리-->
    <!--    <script src="../node_modules/jquery/dist/jquery.js"></script>-->
    <script src="https://code.jquery.com/jquery-3.6.1.slim.min.js"
            integrity="sha256-w8CvhFs7iHNVUtnSP0YKEg00p9Ih13rlL9zGqvLdePA=" crossorigin="anonymous"></script>
    <!--endregion 제이쿼리-->
    <!--region 코드미러-->
    <!--    <script src="../node_modules/codemirror/dist/index.js"></script>-->
    <!--    <script type="module" src="my-codemirror.js"></script>-->
    <!--endregion 코드미러-->
    <!--region 단포-->
    <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.min.js"></script>
    <!--endregion 단포-->

    <!--region 제이스프레드시트-->
    <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css"/>
    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css"/>
    <!--endregion 제이스프레드시트-->
    <!--region D3 산점도 스타일-->
    <style>

        svg {
            font: 10px sans-serif;
            padding: 10px;
        }

        .axis,
        .frame {
            shape-rendering: crispEdges;
        }

        .axis line {
            stroke: #ddd;
        }

        .axis path {
            display: none;
        }

        .cell text {
            font-weight: bold;
            text-transform: capitalize;
            fill: black;
        }

        .frame {
            fill: none;
            stroke: #aaa;
        }

        circle {
            fill-opacity: .7;
        }

        circle.hidden {
            fill: #ccc !important;
        }

        .extent {
            fill: #000;
            fill-opacity: .125;
            stroke: #fff;
        }

    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!--endregion D3 산점도 스타일-->
</head>
<body>

<!--region 로고아이콘-->
<img src="icon.png" alt="" width="50px" height="50px" style="position: absolute; top:5px; left:45px">
<!--endregion 로고아이콘-->

<!--region 상단타이틀바-->
<nav class="navbar navbar-dark navbar-expand-lg bg-dark"
     style="margin-left:100px; margin-right:100px;
     margin-bottom:50px; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;">
    <div class="container-fluid">
        <a class="navbar-brand fw-bolder" href="#">시각적 탐사 데이터 분석 지원 도구</a>
    </div>
</nav>
<!--endregion 상단타이틀바-->

<!--region 확장된 질의 요청-->
<main style="margin-left:100px; margin-right:100px; margin-bottom:50px">
    <div class="flex-shrink-0 p-3 bg-white" style="width: 280px;">
        <a href="#" class="d-flex align-items-center pb-3 mb-3 link-dark text-decoration-none border-bottom">
            <span class="fs-5 fw-semibold">확장된 질의 요청</span>
        </a>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="input-group">
                <textarea id="query" class="form-control" aria-label="With textarea"
                          style="height: 70px; margin-bottom: 20px">
SELECT * FROM IRIS WITHIN 1SEC
                </textarea>
            </div>
        </div>

        <div class="row">
            <div class="col-8">
            </div>
            <div class="col-1">
                <h6 style="margin-top: 10px">실행모드</h6>
            </div>
            <div class="col-2">
                <label>
                    <select class="form-control">
                        <option>디버그 모드</option>
                        <option>런타임 모드</option>
                    </select>
                </label>
            </div>
            <div class="col-1">
                <button type="button" class="btn btn-primary" style="float: right" onclick="request_query()">실행</button>
            </div>
        </div>
    </div>
</main>
<!--endregion 확장된 질의 요청-->

<!--region 정확질의 결과-->
<main style="margin-left:100px; margin-right:100px; margin-bottom:100px">
    <div class="flex-shrink-0 p-3 bg-white" style="width: 280px;">
        <a href="#" class="d-flex align-items-center pb-3 mb-3 link-dark text-decoration-none border-bottom">
            <span class="fs-5 fw-semibold">질의 결과</span>
        </a>
    </div>

    <div class="container-fluid" style="margin-left:10px; margin-bottom:100px">
        <div class="row">
            <div class="col">
                <!--region 그리드 탭-->
                <ul class="nav nav-tabs" id="gridTab" role="tablist" style="margin-bottom: 20px">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold active" id="grid-tab-0" data-bs-toggle="tab"
                                data-bs-target="#grid-content-0" type="button" role="tab" aria-controls="grid-content-0"
                                aria-selected="true">스프레드시트
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="grid-tab-1" data-bs-toggle="tab"
                                data-bs-target="#grid-content-1" type="button" role="tab" aria-controls="grid-content-1"
                                aria-selected="false">피벗 그리드
                        </button>
                    </li>
                </ul>
                <!--endregion 그리드 탭-->
                <!--region 그리드 컨텐츠-->
                <div class="tab-content" id="gridTabContent">
                    <div class="tab-pane fade show active overflow-auto" id="grid-content-0" role="tabpanel"
                         aria-labelledby="grid-tab-0" tabindex="0" style="max-width: 700px; max-height: 700px"></div>
                    <div class="tab-pane fade" id="grid-content-1" role="tabpanel" aria-labelledby="grid-tab-1"
                         tabindex="1" style="max-width: 700px; max-height: 700px">
                        <div id="root"></div>
                    </div>
                </div>
                <!--endregion 그리드-->
            </div>
            <div class="col">
                <!--region 그래프 탭-->
                <ul class="nav nav-tabs" id="chartTab" role="tablist" style="margin-bottom: 20px">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold active" id="chart-tab-0" data-bs-toggle="tab"
                                data-bs-target="#chart-content-0" type="button" role="tab"
                                aria-controls="chart-content-0" aria-selected="true">산점도
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-1" data-bs-toggle="tab"
                                data-bs-target="#chart-content-1" type="button" role="tab"
                                aria-controls="chart-content-1" aria-selected="false">파이차트
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-2" data-bs-toggle="tab"
                                data-bs-target="#chart-content-2" type="button" role="tab"
                                aria-controls="chart-content-3" aria-selected="false">히스토그램
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-3" data-bs-toggle="tab"
                                data-bs-target="#chart-content-3" type="button" role="tab"
                                aria-controls="chart-content-4" aria-selected="false">트리맵
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-4" data-bs-toggle="tab"
                                data-bs-target="#chart-content-4" type="button" role="tab"
                                aria-controls="chart-content-5" aria-selected="false">3차원그래프
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-5" data-bs-toggle="tab"
                                data-bs-target="#chart-content-5" type="button" role="tab"
                                aria-controls="chart-content-6" aria-selected="false">연결그래프
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-6" data-bs-toggle="tab"
                                data-bs-target="#chart-content-6" type="button" role="tab"
                                aria-controls="chart-content-7" aria-selected="false">박스플롯
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="chart-tab-7" data-bs-toggle="tab"
                                data-bs-target="#chart-content-7" type="button" role="tab"
                                aria-controls="chart-content-8" aria-selected="false">지도연계
                        </button>
                    </li>
                </ul>
                <!--endregion 그래프 탭-->
                <!--region 그래프-->
                <div class="tab-content" id="chartTabContent">
                    <div class="tab-pane fade show active overflow-auto d3-scatter" id="chart-content-0" role="tabpanel"
                         aria-labelledby="chart-tab-0" tabindex="0" style="max-width: 700px; max-height: 700px"></div>
                    <div class="tab-pane fade" id="chart-content-1" role="tabpanel" aria-labelledby="chart-tab-1"
                         tabindex="1" style="max-width: 700px; max-height: 700px">파이차트
                    </div>
                    <div class="tab-pane fade" id="chart-content-2" role="tabpanel" aria-labelledby="chart-tab-2"
                         tabindex="2" style="max-width: 700px; max-height: 700px">히스토그램
                    </div>
                    <div class="tab-pane fade" id="chart-content-3" role="tabpanel" aria-labelledby="chart-tab-3"
                         tabindex="3" style="max-width: 700px; max-height: 700px">트리맵
                    </div>
                    <div class="tab-pane fade" id="chart-content-4" role="tabpanel" aria-labelledby="chart-tab-4"
                         tabindex="4" style="max-width: 700px; max-height: 700px">3차원그래프
                    </div>
                    <div class="tab-pane fade" id="chart-content-5" role="tabpanel" aria-labelledby="chart-tab-5"
                         tabindex="5" style="max-width: 700px; max-height: 700px">연결그래프
                    </div>
                    <div class="tab-pane fade" id="chart-content-6" role="tabpanel" aria-labelledby="chart-tab-6"
                         tabindex="6" style="max-width: 700px; max-height: 700px">박스플롯
                    </div>
                    <div class="tab-pane fade" id="chart-content-7" role="tabpanel" aria-labelledby="chart-tab-7"
                         tabindex="7" style="max-width: 700px; max-height: 700px">지도연계
                    </div>
                </div>
                <!--endregion 그래프-->
            </div>
        </div>
    </div>
</main>
<!--endregion 정확질의 결과-->

<!--&lt;!&ndash;region 근사질의 결과&ndash;&gt;-->
<!--<main style="margin-left:100px; margin-right:100px; margin-bottom:100px">-->
<!--    <div class="flex-shrink-0 p-3 bg-white" style="width: 280px;">-->
<!--        <a href="#" class="d-flex align-items-center pb-3 mb-3 link-dark text-decoration-none border-bottom">-->
<!--            <span class="fs-5 fw-semibold">근사질의 결과</span>-->
<!--        </a>-->
<!--    </div>-->

<!--    <div class="container">-->
<!--        <div class="row">-->
<!--            <div class="col">-->
<!--                <ul class="nav nav-tabs" style="margin-left: 50px; margin-bottom:100px">-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link active fw-bold" aria-current="page" href="#">스프레드시트</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">피벗 그리드</a>-->
<!--                    </li>-->
<!--                </ul>-->
<!--            </div>-->
<!--            <div class="col">-->
<!--                <ul class="nav nav-tabs" style="margin-left: 50px; margin-bottom:100px">-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link active fw-bold" aria-current="page" href="#">관계 그래프</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">파이 차트</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">히스토그램</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">트리맵</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">3차원 그래프</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">산점도</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">박스플롯</a>-->
<!--                    </li>-->
<!--                    <li class="nav-item">-->
<!--                        <a class="nav-link" href="#">지도 연계</a>-->
<!--                    </li>-->
<!--                </ul>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</main>-->
<!--&lt;!&ndash;endregion 근사질의 결과&ndash;&gt;-->

<!--&lt;!&ndash;region 정확/근사질의 비교&ndash;&gt;-->
<!--<main style="margin-left:100px; margin-right:100px; margin-bottom:100px">-->
<!--    <div class="flex-shrink-0 p-3 bg-white" style="width: 280px;">-->
<!--        <a href="#" class="d-flex align-items-center pb-3 mb-3 link-dark text-decoration-none border-bottom">-->
<!--            <span class="fs-5 fw-semibold">정확/근사질의 비교</span>-->
<!--        </a>-->
<!--    </div>-->

<!--    <div class="container">-->

<!--        <ul class="nav nav-tabs" style="margin-left: 50px; margin-bottom:100px">-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link active fw-bold" aria-current="page" href="#">스프레드시트</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">피벗 그리드</a>-->
<!--            </li>-->
<!--        </ul>-->

<!--        <ul class="nav nav-tabs" style="margin-left: 50px; margin-bottom:100px">-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link active fw-bold" aria-current="page" href="#">관계 그래프</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">파이 차트</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">히스토그램</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">트리맵</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">3차원 그래프</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">산점도</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">박스플롯</a>-->
<!--            </li>-->
<!--            <li class="nav-item">-->
<!--                <a class="nav-link" href="#">지도 연계</a>-->
<!--            </li>-->
<!--        </ul>-->
<!--    </div>-->
<!--</main>-->
<!--&lt;!&ndash;endregion 정확/근사질의 비교&ndash;&gt;-->

</body>

<script>
    d3.csv("iris.csv", on_csv_loaded)

    function on_csv_loaded(error, data) {
        if (error) throw error

        set_spreed_sheet(data)

        set_d3_scatter(data)
        // set_d3_piechart(data)
    }

    // region 그리드 스프레드시트 스크립트
    function set_spreed_sheet(data) {
        jspreadsheet(document.getElementById('grid-content-0'), {
            data: data,
            columns: [
                {title: 'petal_width', width: 120},
                {title: 'petal_length', width: 120},
                {title: 'sepal_width', width: 120},
                {title: 'sepal_length', width: 120},
                {title: 'species', width: 120, type: 'dropdown', source: ['setosa', 'versicolor', 'virginica']}
            ]
        });
    }

    // endregion 그리드 스프레드시트 스크립트

    // region 시각화 산점도 스크립트
    function set_d3_scatter(data) {
        let width = 640,
            size = 160,
            padding = 10;

        let x = d3.scaleLinear()
            .range([padding / 2, size - padding / 2]);

        let y = d3.scaleLinear()
            .range([size - padding / 2, padding / 2]);

        let xAxis = d3.axisBottom()
            .scale(x)
            .ticks(6);

        let yAxis = d3.axisLeft()
            .scale(y)
            .ticks(6);

        let color = d3.scaleOrdinal(d3.schemeCategory10);

        var domainByTrait = {},
            traits = d3.keys(data[0]).filter(function (d) {
                return d !== "species";
            }),
            n = traits.length;

        traits.forEach(function (trait) {
            domainByTrait[trait] = d3.extent(data, function (d) {
                return d[trait];
            });
        });

        xAxis.tickSize(size * n);
        yAxis.tickSize(-size * n);

        var brush = d3.brush()
            .on("start", brushstart)
            .on("brush", brushmove)
            .on("end", brushend)
            .extent([[0, 0], [size, size]]);

        var svg = d3.select(".d3-scatter").append("svg")
            .attr("width", size * n + padding)
            .attr("height", size * n + padding)
            .append("g")
            .attr("transform", "translate(" + padding + "," + padding / 2 + ")");

        svg.selectAll(".x.axis")
            .data(traits)
            .enter().append("g")
            .attr("class", "x axis")
            .attr("transform", function (d, i) {
                return "translate(" + (n - i - 1) * size + ",0)";
            })
            .each(function (d) {
                x.domain(domainByTrait[d]);
                d3.select(this).call(xAxis);
            });

        svg.selectAll(".y.axis")
            .data(traits)
            .enter().append("g")
            .attr("class", "y axis")
            .attr("transform", function (d, i) {
                return "translate(0," + i * size + ")";
            })
            .each(function (d) {
                y.domain(domainByTrait[d]);
                d3.select(this).call(yAxis);
            });

        var cell = svg.selectAll(".cell")
            .data(cross(traits, traits))
            .enter().append("g")
            .attr("class", "cell")
            .attr("transform", function (d) {
                return "translate(" + (n - d.i - 1) * size + "," + d.j * size + ")";
            })
            .each(plot);

        // Titles for the diagonal.
        cell.filter(function (d) {
            return d.i === d.j;
        }).append("text")
            .attr("x", padding)
            .attr("y", padding)
            .attr("dy", ".71em")
            .text(function (d) {
                return d.x;
            });

        cell.call(brush);

        function plot(p) {
            var cell = d3.select(this);

            x.domain(domainByTrait[p.x]);
            y.domain(domainByTrait[p.y]);

            cell.append("rect")
                .attr("class", "frame")
                .attr("x", padding / 2)
                .attr("y", padding / 2)
                .attr("width", size - padding)
                .attr("height", size - padding);

            cell.selectAll("circle")
                .data(data)
                .enter().append("circle")
                .attr("cx", function (d) {
                    return x(d[p.x]);
                })
                .attr("cy", function (d) {
                    return y(d[p.y]);
                })
                .attr("r", 4)
                .style("fill", function (d) {
                    return color(d.species);
                });
        }

        var brushCell;

        // Clear the previously-active brush, if any.
        function brushstart(p) {
            if (brushCell !== this) {
                d3.select(brushCell).call(brush.move, null);
                brushCell = this;
                x.domain(domainByTrait[p.x]);
                y.domain(domainByTrait[p.y]);
            }
        }

        // Highlight the selected circles.
        function brushmove(p) {
            var e = d3.brushSelection(this);
            svg.selectAll("circle").classed("hidden", function (d) {
                return !e
                    ? false
                    : (
                        e[0][0] > x(+d[p.x]) || x(+d[p.x]) > e[1][0]
                        || e[0][1] > y(+d[p.y]) || y(+d[p.y]) > e[1][1]
                    );
            });
        }

        // If the brush is empty, select all circles.
        function brushend() {
            var e = d3.brushSelection(this);
            if (e === null) svg.selectAll(".hidden").classed("hidden", false);
        }

        function cross(a, b) {
            var c = [], n = a.length, m = b.length, i, j;
            for (i = -1; ++i < n;) for (j = -1; ++j < m;) c.push({x: a[i], i: i, y: b[j], j: j});
            return c;
        }
    }

    function set_d3_piechart(data) {
        let formatSum = d3.format(".1s");
        let padding = 10;
        let radius = d3.scaleSqrt()
            .range([0, 220]);
        let color = d3.scaleOrdinal()
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
        let arc = d3.arc()
            .padRadius(50);
        let pie = d3.pie()
            .sort(null)
            .padAngle(0.02)
            .value(function (d) {
                return d.population;
            });

        var df = new dfd.DataFrame(data)
        // df.ctypes.print()
        // df.print()

        let labels = df['species'].unique()


        radius.domain([0, d3.max(data, function (d) {
            return d.sum;
        })]);

        color.domain(data.columns.slice(1));

        var legend = d3.select("body").append("svg")
            .attr("class", "legend")
            .attr("width", 120)
            .attr("height", (data.columns.length - 1) * 20)
            .selectAll("g")
            .data(data.columns.slice(1).reverse())
            .enter().append("g")
            .attr("transform", function (d, i) {
                return "translate(0," + i * 20 + ")";
            });

        legend.append("rect")
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", color);

        legend.append("text")
            .attr("x", 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .text(function (d) {
                return d;
            });

        var svg = d3.select("body").selectAll(".pie")
            .data(data.sort(function (a, b) {
                return b.sum - a.sum;
            }))
            .enter().append("svg")
            .attr("class", "pie")
            .each(multiple)
            .select("g");

        var label = svg.append("text")
            .attr("class", "label");

        label.append("tspan")
            .attr("class", "label-name")
            .attr("x", 0)
            .attr("dy", "-.2em")
            .text(function (d) {
                return d.state;
            });

        label.append("tspan")
            .attr("class", "label-value")
            .attr("x", 0)
            .attr("dy", "1.1em")
            .text(function (d) {
                return formatSum(d.sum);
            });

        function multiple(d) {
            var r = radius(d.sum);

            var svg = d3.select(this)
                .attr("width", r * 2)
                .attr("height", r * 2)
                .append("g")
                .attr("transform", "translate(" + r + "," + r + ")");

            svg.selectAll(".arc")
                .data(function (d) {
                    return pie(d.ages);
                })
                .enter().append("path")
                .attr("class", "arc")
                .attr("d", arc.outerRadius(r).innerRadius(r * 0.6))
                .style("fill", function (d) {
                    return color(d.data.age);
                });
        }


    }

    // endregion 시각화 산점도 스크립트


</script>

</html>